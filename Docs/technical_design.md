量化系统开发技术文档

一、系统目标与背景思考

在开发层面，需要从更宏观的角度认识这套量化系统。它不仅是一个简单的程序，更是一套可迭代、可扩展的量化平台。结合量化方案文档中对“稳定层”和“进攻层”的细分，系统需要在数据采集、策略执行、风险管控等方面实现灵活衔接。稳定层偏向中长期基本面与财务指标监控，进攻层更注重短期或波段操作的自动化，因此在开发过程中，要同时支持两类思路的落地。

假如业务方在后期还想引入更多市场数据（例如海外市场指标或更多财务数据源），或者需要更前沿的多因子模型，系统的存储结构和脚本管理就需要足够灵活，能支持多次升级迭代。而在数据提取与策略执行的过程中，QMT 客户端承担了回测和准实时交易的重要角色，miniQMT 及未来可能接入的 Tushare、Wind 等则为系统提供了关键数据输入。

二、核心需求与主要功能

从业务视角看，“稳定层”侧重财务指标、分红公告、估值快速飙升等监控，触发预警后由人工决策是否调仓；“进攻层”则更关注事件或因子驱动的自动化操作，包括行业动态检测、个股择时与风控。对开发者而言，需要在系统层面完成下列关键功能：

第一，搭建统一的数据采集与存储模块，确保所有基础行情数据、财务数据、行业与板块信息都能定期或实时更新，并进入同一个数据库。

第二，在数据库及脚本层面实现多因子评分逻辑，将“行业资金评分”“估值评分”“技术指标评分”“筹码与主力控盘评分”等因子在数据库中维护或动态计算，并将综合得分结果输出给后续的策略执行。

第三，实现自动化的风控与交易机制，通过 QMT 客户端或者其他量化引擎来对接买卖信号、回撤监控和仓位管理，最终完成策略回测与实盘指令。

第四，提供一定的可视化能力，如在本地以 Streamlit/Dash 等方式展示当前的个股得分、回撤状况和过往策略执行日志，为人工监控和复盘提供便利。

三、数据结构与开发流程

数据源：优先选择免费且没限制的AKshare

- QMT-极简版（miniQMT, 仅包含：XtQuant.XtData 行情模块以及XtQuant.Xttrader 交易模块）
- AKshare（[https://akshare.akfamily.xyz/data/index.html）](https://akshare.akfamily.xyz/data/index.html%EF%BC%89)
- tushare(https://tushare.pro/document/2)，

数据表结构是整个系统的核心，既要兼顾稳定层相对低频的财务指标，又要满足进攻层较高频的行情和资金面需求。可以考虑以下设计：

1. stock_info
记录每支股票的基础信息：股票代码、名称、所属行业（申万一级或二级分类）、上市日期、是否在进攻层或稳定层重点跟踪等。
2. daily_quote
保存日线行情：日期、股票代码、开盘价、收盘价、最高价、最低价、成交量、成交额等。每个交易日收盘后自动更新。若需要更高频数据（分钟线、分时量），可建立相应的 minute_quote / tick_quote 表。
3. finance_data
定期抓取财务和分红指标：ROE、EPS、PB、PE、分红派息等信息。对稳定层而言，可以把分红率、估值水位等关键字段设定阈值，并在数据库中标记，如高于某值则插入预警标志。
4. funds_flow（可选）
若要关注北向资金、融资余额、融券余量等，可在此表记录每日资金流动数据。这样在行业或个股层面计算“资金吸引度”时，可直接在该表进行查询比对。
5. signals
专门用于存储各类量化信号与评分结果，包括：
• 进攻层：每支股票的行业得分、估值得分、技术指标得分、筹码面得分等，可按日期定时计算并存储。综合分数 ≥ 5 分时则标记为“买入信号”，并附上止盈止损价格。
• 稳定层：若某股票连续两个季度分红率过低或 PE/PB 飙升，则产生预警记录在此表，等待人工评估是否调仓。

这些数据表可以存放于 MySQL 或 PostgreSQL。每日或定期由开发脚本从 数据源接口获取数据并写入数据库。若 QMT 无法直接调用外部接口，可将数据另存为 CSV 文件，让 QMT 脚本在本地目录中读取。

四、稳定层逻辑与实现

在稳定层，系统的自动化程度相对较低，仅需在日常或定期模型运转中关注：

1. 财务数据：季度或半年一次导入 ROE、EPS、分红率、PB、PE 等，并在本地持久化；
2. 监控规则：若分红率低于指定阈值、估值偏高到一定程度，或者连续两个季度业绩大幅下滑，则在 signals 表中插入预警信息；
3. 通知与人工决策：可以在 UI 或日志系统中突出显示该预警，决策者可手动执行调仓或深入研究。系统本身仅提供提示，不做自动买卖。

从开发角度看，核心开发工作包括：

• 定期爬取或调取财务数据，把更新周期写入 Cron 任务或定时脚本；

• 在插入/更新数据库后，执行一段检查逻辑（例如 Python 或 SQL 脚本）来判断哪些股票需要触发预警；

• 将触发结果写入 signals 表，同时在日志或 UI 中做醒目标注。

五、进攻层逻辑与实现

进攻层的重点是自动化与交易执行，包含以下环节:

1. 行业/板块动态检测：
    
    每天收盘后或盘中，读取 funds_flow 表中相关行业或板块的资金流入统计，计算近几日的环比变化率。也可读取融券余额看空情况，对评分进行调整。
    
2. 个股择时：
    
    系统基于technical_indicator 表或 daily_quote 内的 MACD、分时量比、突破形态进行分析，把每个指标的结果存入 signals 表中的字段，如 macd_score、volume_score 等。还会查询筹码分布数据（若有外部接口或自行统计）来推算主力控盘度、筹码峰集中度，并纳入得分体系。
    
3. 综合得分计算：
    
    把行业资金得分、估值得分、技术指标得分、筹码面得分汇总。若综合分≥某阈值（如 5），则在 signals 表中标记“buy = True”、“优先级 = 高”。同理，如果分数持续走低或触发止损线，则标记“sell = True”、“原因 = 止损” 。
    
4. 风控执行：
    
    进攻层会涉及自动止盈止损、回撤监控等。为了在 QMT 客户端执行这些指令，系统可在 signals 表或外部文件中记录如“止盈价/止损价”“预期收益目标”等。QMT 策略脚本在开盘或实时根据最新信息决策是否真正下单，若市价触发止盈或止损也要及时写回数据库，用于实时风控与后续复盘。
    
5. 交易周期与轮动：
    
    可以按周或月度在行业层面做一次大区间轮动（从 funds_flow 中找 Top N 行业），再对这些行业下的个股做进攻评分，挑选 Top M 个股进入进攻层组合。要避免过度集中，单一行业或个股的仓位占比可做限制。
    

六、回测与实盘衔接

从开发视角，回测与实盘对系统的交互方式并不完全相同，但都要访问同样的数据与信号：

1. 回测
    
    QMT 端会在策略脚本中从数据库中批量读取历史行情、财务数据、资金流信息，然后根据进攻层或稳定层的规则执行交易模拟，输出收益、回撤、夏普比率等指标。最好在 signals 表或单独的 backtest_log 表中记录每次回测的买入卖出明细。
    
2. 实盘
    
    实盘交易时，QMT 策略脚本可以定时获取 signals 表中的最新打分与买卖信号，结合现价判断是否执行交易。若交易成功，可将成交结果即时或批量写入另一个 trades 表，以备后续复盘与绩效统计。
    
3. 审计与复盘
    
    在数据库或文件系统中保留所有回测和实盘日志，建议每周或每月对照 signals、daily_quote、trades 进行对账，评估策略执行是否正确，是否符合业务需求。若发现偏差，可溯源到具体因子或数据更新时点进行修正。
    

七、UI 展示与通知机制

为了让业务方和研究员能够快速了解策略运作，建议开发一个简洁的前端UI或脚本式输出：

1. 数据可视化
    
    可用 Streamlit 或 Dash 集成到 Python 脚本中，读取数据库 signals、daily_quote 等表，形成实时或准实时的图表与表格。研究员能快速查看个股得分、预期买点、风控价位等信息。
    
2. 预警与日志
    
    在稳定层出现财务预警时，或进攻层触发止损时，系统可以自动发邮件、短信或企业微信提醒。将这些通知事件也写入一个名为 alerts_log 的表，以便后续统计。
    
3. 日志和审计
    
    所有关键操作，如生成信号、执行交易、触发风控，都需要被记录。无论是开发者还是业务方，都应能在回头时查看具体细节，确认策略执行过程是否正确、因子分数是否计算准确。
    

八、Cursor 集成与项目协作

因为本项目大量使用 Cursor 进行开发，可以在 .cursorrules 文件中维护三个关键信息区：

1. Lessons
记录每次重要的技术问题或改进经验，例如数据库结构改动原因、某个脚本的优化建议等，防止重复踩坑。
2. Scratchpad
在开始新任务或新功能开发时，用于草稿式讨论或 todo 列表，帮助团队成员快速接手开发。
3. Tools
对接外部脚本、爬虫或其他集成的地方，需要记录命令示例和参数说明，方便后续人员复用。

九、未来扩展与潜在业务疑问

如果未来需要支持更多数据源（如 Tushare、Wind、舆情爬虫），只要在同一数据库中增设相应的数据表和更新脚本即可。但这个过程需要业务方给出更明确的需求（例如要监控哪些舆情关键词、哪些国际市场指数），开发端再评估数据可得性和更新频度。如果对回测效率有更高要求，也要考虑数据库分区、数据分发或使用内存数据库加速。

如果业务方面在收益目标、风险容忍度或行业划分标准上发生较大变动，也需要及时反馈给开发团队更新打分逻辑和风控阈值。尤其在大盘崩盘时是否自动减仓、止损线是否跟随波动调整，这些都需要和业务方协商，并在代码和数据库字段里留好灵活配置的空间。

如果在后续沟通中发现业务信息有缺失之处，例如还没有统一定义行业分类标准或核心财务指标口径不一致，需要及时补充，否则在技术落地时可能出现数据对不齐、打分逻辑难以统一的问题。
